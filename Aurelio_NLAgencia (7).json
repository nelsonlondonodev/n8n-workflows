{
  "name": "Aurelio_NLAgencia",
  "nodes": [
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1G3BC4DyxPRKgNvcGdIY2VavH8UrQTNK2aUjBOj-BP80",
          "mode": "list",
          "cachedResultName": "Leads NLAgencia",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1G3BC4DyxPRKgNvcGdIY2VavH8UrQTNK2aUjBOj-BP80/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1G3BC4DyxPRKgNvcGdIY2VavH8UrQTNK2aUjBOj-BP80/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Id": "={{ $execution.id }}",
            "Fecha": "={{ $today.toFormat('yyyy-MM-dd') }}",
            "Hora": "={{ $now.toFormat('HH:mm') }}",
            "Nombre": "={{ $json.nombre }}",
            "Correo": "={{ $json.correo }}",
            "Tel√©fono": "={{ $json.telefono }}",
            "Asunto": "={{ $json.pregunta }}",
            "Estado": "Nuevo Lead - Chatbot"
          },
          "matchingColumns": [
            "Correo"
          ],
          "schema": [
            {
              "id": "Id",
              "displayName": "Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fecha",
              "displayName": "Fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hora",
              "displayName": "Hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Correo",
              "displayName": "Correo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Tel√©fono",
              "displayName": "Tel√©fono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Asunto",
              "displayName": "Asunto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Estado",
              "displayName": "Estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "e1f5b391-ecca-42f1-81e7-478295a8ae1d",
      "name": "4. Google Sheets: Guarda Datos del Cliente",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        1136,
        112
      ],
      "inputs": {
        "input": [
          {
            "id": "848e1ddc-4a37-4d9f-a2e4-e0c159c9527a",
            "name": "IF - Datos Recibidos"
          }
        ]
      },
      "data": "={{ { \"values\": [ [ $json.body.nombre, $json.body.correo, $json.body.telefono, $nodes['1. IA: Entiende al Cliente'].json.output.temas.join(', ') ] ] } }}",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "tcZSbjllvaDsf7WV",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.correo }}",
              "operation": "isNotEmpty"
            },
            {
              "value1": "={{ $json.nombre }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "d5ecb38e-fbd4-4781-b873-9a3926ff49db",
      "name": "3. IF: ¬øEl cliente dio sus datos?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        880,
        128
      ]
    },
    {
      "parameters": {
        "chatId": "1419397006",
        "text": "={{ $json.Estado }}:\n\n*Id:* {{ $json.Id }}\n*Nombre:* {{ $json.Nombre }}\n*Correo:* {{ $json.Correo }}\n*Tel√©fono:* {{ $json['Tel√©fono'] }}\n\n*Consulta Inicial:* {{ $json.Asunto }}\n",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "62d18a0e-2e1f-4f3d-a03d-be5f22edfa0e",
      "name": "6. Telegram: Notifica al Equipo de Ventas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1344,
        112
      ],
      "webhookId": "4802d561-7267-4325-a53f-bc2be17b7fbd",
      "credentials": {
        "telegramApi": {
          "id": "j2qbrjobdLEF2ZA9",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $('Code in JavaScript').item.json.accion }}",
              "value2": "email"
            }
          ]
        }
      },
      "id": "d02753b4-0927-4d3d-a423-e267fb35088a",
      "name": "5. IF: ¬øQuiere correo o llamada?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1568,
        112
      ]
    },
    {
      "parameters": {
        "content": "### L√≥gica del Workflow\n\nEste workflow est√° dise√±ado para ser simple. El nodo **Webhook** espera recibir toda la informaci√≥n en un solo env√≠o para facilitar el aprendizaje.\n\nEn una aplicaci√≥n real, tendr√≠as m√∫ltiples webhooks o una l√≥gica m√°s compleja para una conversaci√≥n fluida.",
        "height": 216,
        "width": 444,
        "color": 4
      },
      "id": "027ff97a-2bcc-4813-aebc-34ab3b8f4592",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -304,
        -256
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ response: $('Code in JavaScript').item.json.dateTime ? '¬°Perfecto! Hemos agendado tu llamada. Revisa tu calendario para ver la invitaci√≥n.' : '¬°Listo! Te hemos enviado un correo con la informaci√≥n que solicitaste.' }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2864,
        368
      ],
      "id": "b942df3b-c48c-45b2-ad17-d123e2747512",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "34b5ab96-ecf0-4195-93de-e3923c2062e5",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -208,
        128
      ],
      "id": "b9a68939-2f14-4433-b132-2e0c63fbae17",
      "name": "Inicio_flujo",
      "webhookId": "34b5ab96-ecf0-4195-93de-e3923c2062e5"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Set: Variables Globales').item.json.sessionId_final }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        320,
        464
      ],
      "id": "deb919ba-1091-4cb2-8a8c-15f9bc1f2ac4",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.message }}",
        "options": {
          "systemMessage": "=# PERSPECTIVA: Eres \"Asistente de NLAgencia\"\n     \n     Eres \"Aurelio\", el asistente virtual de la agencia de marketing digital \"NLAgencia\". Tu tono es \n      cercano, proactivo y muy amigable, ¬°siempre con un toque de entusiasmo! Imagina que est√°s charlando\n      con alguien para ayudarle a que su negocio despegue. Tu misi√≥n principal es hacer que los usuarios \n      se sientan bienvenidos, resolver sus dudas y convertirlos en prospectos cualificados.\n     \n     # OBJETIVOS:\n     \n     1.  **Responder Preguntas y Educar:** Responde a las preguntas de los usuarios sobre nuestros \n      servicios (SEO, dise√±o web, etc.) de forma clara, concisa y **utilizando analog√≠as sencillas y \n      ejemplos pr√°cticos** para reforzar la comprensi√≥n, especialmente cuando el usuario pregunta c√≥mo un\n      servicio puede ayudar a su negocio (ej. \"c√≥mo el SEO puede ayudar a mi restaurante\"). Para ello, \n      DEBES usar la herramienta `Info_NLAgencia`.\n     2.  **Capturar Prospectos:** Despu√©s de resolver una consulta, tu objetivo es guiar al usuario \n      hacia uno de los siguientes pasos: \"recibir la informaci√≥n por correo\" o \"agendar una llamada\".\n     3.  **Extraer Datos:** Si el usuario acepta una de las dos opciones, debes solicitar amablemente su\n      **nombre completo, correo electr√≥nico y n√∫mero de tel√©fono**.\n    \n    # REGLAS DE ACTUACI√ìN (El Flujo de la Conversaci√≥n):\n    \n    1.  **Gesti√≥n de Relevancia y Saludos (MUY IMPORTANTE):** Tu primera tarea es evaluar el mensaje \n      del usuario. Si es un simple saludo (ej: \"hola\", \"buenos d√≠as\") o no parece relacionado con \n      servicios de marketing, Y LA CONVERSACI√ìN ACABA DE EMPEZAR (no hay historial previo), debes \n      responder con: *\"¬°Hola! Soy Aurelio, tu asistente virtual. ¬øEn qu√© puedo ayudarte con nuestros \n      servicios de marketing?\"*. Si la conversaci√≥n ya est√° en curso (por ejemplo, si t√∫ acabas de hacer \n      una pregunta), debes responder siempre de forma natural y contextual a lo que el usuario diga, sin \n      importar si su respuesta es corta o no contiene palabras clave.\n    \n    2.  **Analiza y Busca:** Al recibir la primera pregunta de un usuario sobre servicios, primero \n      enti√©ndela y luego utiliza inmediatamente la herramienta `Info_NLAgencia` para encontrar la \n      respuesta.\n    \n    3.  **Gesti√≥n de Mensajes Complejos:** Si un usuario env√≠a un mensaje muy largo con m√∫ltiples \n      preguntas o datos a la vez, procesa la informaci√≥n de forma secuencial. Primero, responde a la \n      pregunta principal sobre los servicios. Una vez resuelta, si ya tienes los datos del cliente \n      gracias a ese primer mensaje, procede directamente a confirmar la captaci√≥n de datos y ofrece el \n      siguiente paso (correo/llamada). No intentes hacer todo en una sola respuesta para evitar \n      confusiones y mantener el control de la conversaci√≥n.\n    \n    4.  **Gesti√≥n de Preguntas sobre Precios (Venta de Valor):** Si un usuario pregunta directamente \n      por el precio de un servicio (ej. \"¬øcu√°nto vale el SEO?\"), **NO respondas inmediatamente con la \n      cifra.** En su lugar, sigue este proceso de venta consultiva:\n        *   **Paso 1: Acuse de Recibo y Pivote:** Reconoce su pregunta y expl√≠cale por qu√© es \n      importante entender el valor primero. Ejemplo: *\"¬°Claro! En un momento te doy la informaci√≥n de \n      precios. Antes, me parece importante contarte brevemente los beneficios, porque en NLAgencia no \n      vendemos servicios, sino resultados. Nuestro enfoque es un 'win-win'.\"*\n        *   **Paso 2: Explicaci√≥n de Beneficios:** Describe los beneficios clave del servicio, \n      bas√°ndote en la informaci√≥n de la herramienta `Info_NLAgencia`.\n        *   **Paso 3: Pregunta de Cualificaci√≥n:** Haz una pregunta para entender mejor su necesidad. \n      Ejemplo: *\"Para asegurarme de que este servicio es lo que realmente necesitas, ¬øpodr√≠as contarme un\n      poco sobre tu negocio y tus objetivos?\"*\n        *   **Paso 4: Entrega del Precio:** Una vez que el usuario responda, AHORA S√ç, dale el precio. \n      Ejemplo: *\"Gracias por la informaci√≥n. Para un negocio como el tuyo, nuestro plan de optimizaci√≥n \n      continua de SEO tiene un precio desde 275 ‚Ç¨/mes.\"*\n        *   **Paso 5: Llamada a la Acci√≥n:** Inmediatamente despu√©s de dar el precio, ofrece el \n      siguiente paso con la regla #7.\n    \n    5.  **Gesti√≥n de Servicios NO Ofrecidos (MUY IMPORTANTE):** Si un usuario pregunta por un servicio \n      que no est√° expl√≠citamente en tu base de conocimiento (como \"gesti√≥n de redes sociales\"), **NO \n      digas un \"no\" rotundo**. En su lugar, adopta un enfoque consultivo. Responde explicando que, aunque\n      tu especialidad no es la gesti√≥n diaria de redes, los servicios que S√ç ofreces (como branding, \n      dise√±o web y SEO) son la base fundamental para que cualquier estrategia en redes sociales tenga \n      √©xito. Inmediatamente despu√©s, haz una pregunta para redirigir la conversaci√≥n y entender su \n      negocio.\n        *   **Ejemplo de respuesta:** *\"¬°Entiendo perfectamente tu inter√©s en las redes sociales! \n      Aunque no llevamos la gesti√≥n del d√≠a a d√≠a, nos especializamos en crear los pilares para que tus \n      redes sociales realmente funcionen: una marca s√≥lida, una web profesional que convierta visitas, y \n      un buen posicionamiento con SEO. Para darte una mejor orientaci√≥n, ¬øpodr√≠as contarme un poco sobre \n      tu negocio o producto?\"*\n    \n    6.  **Reconocer el Fin de la Conversaci√≥n (REGLA CR√çTICA):** Si el usuario ya ha recibido la \n      informaci√≥n o una confirmaci√≥n (por correo o llamada), y su siguiente mensaje es de agradecimiento \n      (ej: \"gracias\", \"perfecto\", \"recibido\", \"muchas gracias por la buena informaci√≥n\") o de cierre, la \n      conversaci√≥n ha terminado. Tu respuesta debe ser un cierre amable y final. NO vuelvas a ofrecer \n      enviarle un correo o agendar una llamada.\n        *   **Ejemplo de respuesta final:** *\"¬°De nada! Ha sido un placer ayudarte. Si en el futuro \n      tienes m√°s preguntas o quieres iniciar un proyecto, no dudes en volver a contactarme. ¬°Que tengas \n      un excelente d√≠a!\"*\n    \n    7.  **Responde y Ofrece:** Si la conversation no ha terminado (seg√∫n las reglas anteriores), \n      proporciona la informaci√≥n que encontraste de forma clara y concisa. Inmediatamente despu√©s, \n      pregunta qu√© le gustar√≠a hacer a continuaci√≥n. Ejemplo: \"¬°Espero que esto te sea de gran ayuda! ¬øQu\n      √© te parece si te env√≠o la info a tu correo para que la tengas a mano, o si prefieres, agendamos \n      una llamada r√°pida para charlarlo mejor?\"\n    \n    7.1. **Si elige correo(email), no enviar los datos al nodo corespondiente hasta que tengas la \n      informaci√≥n completa. Ej. \"nombre, correo, telefono, pregunta\".\n    \n    7.2. **Si elige llamada(agendar), no enviar los datos al nodo corespondiente hasta que tengas la \n      informaci√≥n completa. Ej. \"nombre, correo, telefono, pregunta\".\n    \n    ***(REGLA #8 MODIFICADA)***\n    8.  **Petici√≥n de Datos:**\n        *   Tanto si el usuario elige \"correo\" como si elige \"llamada\", tu siguiente paso es pedirle \n      amablemente su **nombre completo, correo electr√≥nico y n√∫mero de tel√©fono**.\n    \n    9.  **Extrae Todos los Datos:** Una vez que el usuario responda, extrae la informaci√≥n clave: \n      **nombre, correo, tel√©fono** y **tema de interes**.\n    \n    ***(REGLA #9.1 ELIMINADA)***\n    *(La antigua regla 9.1 sobre zona horaria ha sido eliminada)*\n    \n    10. **Confirma y Cierra:** Finaliza la conversaci√≥n con un mensaje de confirmaci√≥n. Ejemplo: \n      \"¬°Genial, ya tengo todo apuntado! En breve, uno de nuestros expertos se pondr√° en contacto contigo.\n      ¬°Que tengas un d√≠a estupendo!\"\n    \n    ***(REGLA #11 MODIFICADA)***\n    11. **Regla del JSON Final (CR√çTICO):** Cuando hayas recopilado todos los datos necesarios (nombre,\n      correo, tel√©fono), \"tu √∫nica y final respuesta DEBE ser un bloque de c√≥digo JSON y nada m√°s\". No \n      a√±adas ning√∫n texto explicativo antes o despu√©s. Sigue estas sub-reglas estrictamente:\n        *   **Sub-regla 11.1 (Contexto de la Pregunta):** El campo `\"pregunta\"` DEBE contener siempre \n      el tema principal y original de la consulta (ej. \"SEO\", \"Dise√±o Web\", \"Branding\"). Debes recordarlo\n      del historial de la conversaci√≥n, NUNCA vuelvas a pregunt√°rselo al usuario.\n        *   **Sub-regla 11.2 (L√≥gica de Acci√≥n):** Debes incluir dos nuevos campos para indicar la \n      acci√≥n deseada.\n            *   El campo `\"dateTime\"` DEBE ser **siempre `null`**.\n            *   Debes a√±adir un nuevo campo llamado `\"accion\"` que indique la elecci√≥n del usuario. Su \n      valor debe ser `\"email\"` o `\"llamada\"`.\n    \n        La estructura final debe ser as√≠ (ejemplo si elige \"llamada\"):\n      {\n        \"nombre\": \"Aurelio Cliente\",\n        \"correo\": \"cliente@ejemplo.com\",\n        \"telefono\": \"+34600123456\",\n        \"pregunta\": \"Servicio de SEO\",\n        \"dateTime\": null,\n        \"accion\": \"llamada\"\n      }\n        *(Nota: pon \"email\" si el usuario eligi√≥ el correo)*\n    \n    12. **Regla de Idioma (MUY IMPORTANTE):** Tu √∫nica lengua de comunicaci√≥n es el espa√±ol. Bajo \n     ninguna circunstancia debes responder en otro idioma. Si un usuario te escribe en ingl√©s o cualquier\n     otro idioma, o te pide que cambies de idioma, DEBES responder amablemente en espa√±ol con un mensaje \n     como: \"Hola, gracias por tu inter√©s. De momento solo puedo atenderte en espa√±ol. ¬øEn qu√© puedo \n     ayudarte con nuestros servicios de marketing?\" y luego continuar la conversaci√≥n en espa√±ol."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        224,
        128
      ],
      "id": "31cac88a-c926-4c96-a79a-78adee0e420b",
      "name": "Aurelio"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        224,
        352
      ],
      "id": "317f0aec-eb77-4e53-ba44-0e7eebd759a2",
      "name": "S√©neca",
      "credentials": {
        "openAiApi": {
          "id": "E7ASXFovwJjGLOin",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Accedemos al texto que nos llega del nodo anterior (\"Aurelio\")\nconst inputText = item.json.output;\n\n// Usamos una expresi√≥n regular para encontrar el bloque JSON que contenga datos de cliente (ej: \"nombre\")\nconst match = inputText.match(/{[\\s\\S]*\"nombre\"[\\s\\S]*}/);\n\n// Si se encuentra el bloque de datos del cliente, lo procesamos.\nif (match && match[0]) {\n  try {\n    // Intentamos convertir (parsear) la coincidencia encontrada\n    const jsonData = JSON.parse(match[0]);\n\n    // Devolvemos el objeto JSON parseado\n    return { json: jsonData };\n\n  } catch (error) {\n    // Si hay un error de parseo, devolvemos la conversaci√≥n original para no romper el chat.\n    return item;\n  }\n}\n\n// Si no se encuentra un bloque de datos, es una conversaci√≥n. Devolvemos el item original.\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        128
      ],
      "id": "7d80ee12-3138-4ffb-a676-54c7d2fb6dc4",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "get",
        "documentURL": "=https://docs.google.com/document/d/1jg30qMHEl8dwGNOQCemGvLHqQDs3PJKr7LxBM1CsdNw/edit?usp=sharing"
      },
      "type": "n8n-nodes-base.googleDocsTool",
      "typeVersion": 2,
      "position": [
        416,
        336
      ],
      "id": "db15325f-69f1-477d-9bf6-73d7d46f487a",
      "name": "Info_NLAgencia",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "6Os75KqCfm6aecQ3",
          "name": "Google Docs account 2"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ response: $json.output }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        880,
        448
      ],
      "id": "1d14e90d-49c6-4741-bf40-946a60b06808",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "content": "üèÅ **Inicio: Webhook**\n\nEste es el punto de entrada. Recibe el mensaje del usuario (ej. `body.message`) y el `body.sessionId` para gestionar la memoria del chat.",
        "height": 594,
        "width": 444
      },
      "id": "15247675-43b1-4266-9fcb-3e1858c4db66",
      "name": "Nota: Webhook Trigger",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -304,
        -16
      ]
    },
    {
      "parameters": {
        "content": "üß† **Cerebro del Asistente (Aurelio)**\n\nEste agente de LangChain procesa el mensaje. Usa:\n- `S√©neca`: El modelo LLM (GPT-4 mini) para pensar.\n- `Simple Memory`: Para recordar la conversaci√≥n.\n- `Info_NLAgencia`: (Google Doc) como base de conocimiento para responder sobre servicios.",
        "height": 750,
        "width": 364,
        "color": 2
      },
      "id": "8af46d8b-dde9-442e-9d0f-44453f369a56",
      "name": "Nota: Agente AI",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        160,
        -176
      ]
    },
    {
      "parameters": {
        "content": "üîç **Parser: ¬øChat o Lead?**\n\nEste nodo de C√≥digo (JavaScript) es clave. Revisa la respuesta del AI:\n\n- **Si es chat normal:** Pasa el texto.\n- **Si es un JSON (con 'nombre', 'correo', etc.):** Extrae los datos del cliente.",
        "height": 474,
        "width": 236,
        "color": 3
      },
      "id": "bbc1a1e9-e4dd-4ac1-8e64-d3f13d1fb981",
      "name": "Nota: Parser JS",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        544,
        -176
      ]
    },
    {
      "parameters": {
        "content": "ü§î **Verificaci√≥n de Datos**\n\nEl nodo `IF` comprueba si el Parser extrajo datos de un cliente (nombre y correo no est√°n vac√≠os).\n\n- **Ruta [TRUE] (Abajo):** ¬°Lead Capturado! Inicia el proceso de guardado.\n- **Ruta [FALSE] (Recto):** Conversaci√≥n en curso. Devuelve la respuesta del chat.",
        "height": 478,
        "width": 252,
        "color": 7
      },
      "id": "ddb5ee17-c1ee-4849-967e-095899d52736",
      "name": "Nota: IF Datos",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        800,
        -176
      ]
    },
    {
      "parameters": {
        "content": "üí¨ **Flujo: Conversaci√≥n Activa**\n\nLa respuesta del AI (texto normal) se env√≠a de vuelta al usuario para continuar la charla.",
        "height": 256,
        "width": 508,
        "color": 5
      },
      "id": "5b6acbe2-2af0-4d14-9789-cc81c3f15577",
      "name": "Nota: Flujo Chat",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        544,
        320
      ]
    },
    {
      "parameters": {
        "content": "‚úÖ **Flujo: Lead Capturado**\n\n1.  **Google Sheets**: Guarda/actualiza los datos del lead en la hoja de c√°lculo.\n2.  **Telegram**: Env√≠a una notificaci√≥n instant√°nea al equipo de ventas.",
        "height": 758,
        "width": 412,
        "color": 6
      },
      "id": "0329388a-7718-4b93-9fea-fdf12e5abb4e",
      "name": "Nota: Flujo Lead",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1072,
        -176
      ]
    },
    {
      "parameters": {
        "content": "üé¨ **Acci√≥n Final: ¬øCorreo o Llamada?**\n\nBasado en el campo `accion` del JSON del lead:\n\n- **[TRUE] (Recto):** El usuario pidi√≥ email. Se env√≠a el correo de Gmail.\n- **[FALSE] (Abajo):** El usuario pidi√≥ llamada. Se env√≠a la respuesta con el enlace de Calendly.",
        "height": 750,
        "width": 700,
        "color": 4
      },
      "id": "a372302b-d79f-4aa3-adc9-fa26ecb55b30",
      "name": "Nota: IF Acci√≥n",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1504,
        -176
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "dcdd6892-bb63-4a29-b4cf-0317f3a8b0c1",
              "name": "email_html",
              "value": "=`<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Informaci√≥n sobre nuestros servicios - NLAgencia</title>\n    <style>\n      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f4f4f4; }\n      .wrapper { width: 100%; table-layout: fixed; background-color: #f4f4f4; }\n      .webkit { max-width: 600px; background-color: #ffffff; }\n      .outer { Margin: 0 auto; width: 100%; max-width: 600px; border-spacing: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }\n      .header { text-align: center; padding: 20px; border-bottom: 1px solid #eeeeee; }\n      .header h1 { color: #2c3e50; margin: 0; font-size: 24px; }\n      .content { padding: 30px 20px; }\n      .content p { margin-bottom: 1.2em; }\n      .cta-button { display: inline-block; background-color: #3498db; color: #ffffff; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; }\n      .cta-button:hover { background-color: #2980b9; }\n      .footer { text-align: center; padding: 20px; border-top: 1px solid #eeeeee; font-size: 0.9em; color: #777; }\n    </style>\n</head>\n<body>\n    <center class=\"wrapper\">\n      <div class=\"webkit\">\n        <table class=\"outer\" align=\"center\">\n          <tr>\n            <td>\n              <div class=\"header\" style=\"text-align: center; padding: 20px; border-bottom: 1px solid #eeeeee;\">\n                <img src=\"https://nelsonlondono.es/image/logo-nelson.webp\" alt=\"Logo de NLAgencia\" style=\"display: block; margin: 0 auto; width: 220px; height: auto;\">\n              </div>\n              <div class=\"content\">\n                <p>Hola {{ $json.Nombre }},</p>\n                <p>Gracias por tu inter√©s en NLAgencia. Tal como lo solicitaste, aqu√≠ tienes m√°s informaci√≥n sobre nuestros servicios de <strong>{{ $json.nombre_servicio }}</strong>.</p>\n                \n                <p>{{ $json.detalle_servicio }}</p>\n                \n                <p>Entendemos que cada negocio es √∫nico. Por eso, el siguiente paso ideal es tener una breve charla para entender tus objetivos y ver c√≥mo podemos ayudarte a alcanzarlos.</p>\n                <p><strong>¬øListo para dar el siguiente paso?</strong></p>\n                \n                <p style=\"text-align:center; margin: 30px 0;\">\n                  <a href=\"{{ $('Set: Variables Globales').item.json.link_agenda }}\" target=\"_blank\" class=\"cta-button\">Agendar Consultor√≠a Gratuita</a>\n                </p>\n                \n                <p>Si prefieres, simplemente responde a este correo con cualquier duda que tengas. Estar√© encantado de ayudarte.</p>\n              </div>\n              <div class=\"footer\">\n                <p>Un saludo cordial,<br><strong>Nelson Londo√±o</strong><br>Fundador, NLAgencia</p>\n              </div>\n            </td>\n          </tr>\n        </table>\n      </div>\n    </center>\n</body>\n</html>`",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2384,
        368
      ],
      "id": "2482dcdc-5a5c-4a1b-9130-904e13560665",
      "name": "Set: Plantilla Email"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Code in JavaScript').item.json.pregunta }}",
                    "rightValue": "SEO",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "94ff14f2-209f-48ea-a60e-41adc235a104"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e37305f3-da17-49f6-9804-31d8919e421d",
                    "leftValue": "={{ $('Code in JavaScript').item.json.pregunta }}",
                    "rightValue": "Dise√±o Web",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6221bdc2-4c02-4f7e-8952-9c6cccb92bbe",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1776,
        80
      ],
      "id": "d94b668d-0aeb-417a-85d6-eda557dd58fb",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fba3d87a-ccf7-4bd3-8a7d-1599bfa570fb",
              "name": "nombre_servicio",
              "value": "Optimizaci√≥n SEO",
              "type": "string"
            },
            {
              "id": "42d233a1-5ec3-44f1-baa5-4befe9d7be36",
              "name": "detalle_servicio",
              "value": "=\n<p>¬°El SEO (Optimizaci√≥n para Motores de B√∫squeda) es clave! Es como poner tu negocio en la calle principal de Internet: <strong>hacemos que tus clientes te encuentren justo cuando te est√°n buscando en Google.</strong></p>\n\n<p>Nuestro servicio de <strong>Optimizaci√≥n SEO</strong> no se trata de trucos, sino de construir una base s√≥lida para tu negocio:</p>\n<ul style=\"padding-left: 20px;\">\n  <li><strong>Auditor√≠a SEO Completa:</strong> Analizamos tu web y la de tu competencia para encontrar oportunidades de oro.</li>\n  <li><strong>Optimizaci√≥n On-Page:</strong> Ajustamos tus t√≠tulos, descripciones y velocidad de carga para que Google \"se enamore\" de tu sitio.</li>\n  <li><strong>SEO Local:</strong> Imprescindible si tienes un negocio f√≠sico. Te posicionamos en Google Maps para atraer clientes de tu zona.</li>\n  <li><strong>Creaci√≥n de Contenido:</strong> Desarrollamos art√≠culos de blog y p√°ginas de servicio que responden a las preguntas de tus clientes y atraen tr√°fico de calidad.</li>\n</ul>\n<p>El SEO es una marat√≥n, no un sprint, pero es la inversi√≥n con el retorno m√°s sostenible a largo plazo.</p>\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2032,
        -48
      ],
      "id": "e35b1b41-1eaa-4c22-a0a1-06e0e7b66f2f",
      "name": "Set: Contenido SEO"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08050109-87c6-4bf1-99af-f442417d0625",
              "name": "nombre_servicio",
              "value": "Dise√±o Web Profesional",
              "type": "string"
            },
            {
              "id": "42d71d51-4a7f-4850-a2ad-8c6ba66379dc",
              "name": "detalle_servicio",
              "value": "=` <p>Tu p√°gina web es tu escaparate digital. Nos aseguramos de que no solo sea atractiva, sino que est√© <strong>optimizada para convertir visitantes en clientes.</strong></p>  <p>Nuestro servicio de <strong>Dise√±o Web Profesional</strong> se enfoca en 3 pilares clave:</p> <ul style=\"padding-left: 20px;\">   <li><strong>Dise√±o Responsive:</strong> Se ver√° perfecto en ordenadores, tablets y, lo m√°s importante, en m√≥viles.</li>   <li><strong>Velocidad de Carga (WPO):</strong> Un sitio r√°pido es crucial. Optimizamos cada imagen y script para que tu web vuele.</li>   <li><strong>Experiencia de Usuario (UX):</strong> Dise√±amos un camino claro para que tus clientes encuentren lo que buscan y te contacten f√°cilmente.</li> </ul> <p>Puedes ver algunos de nuestros trabajos recientes en <a href=\"https://tu-agencia.com/portafolio\" target=\"_blank\">nuestro portafolio</a>.</p> `",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2032,
        96
      ],
      "id": "861a6738-b46f-4a99-bf55-501ea4b0dbc5",
      "name": "Set: Contenido Web"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7594356c-3019-4272-be22-5aa1653d82ce",
              "name": "nombre_servicio",
              "value": "=Nuestros Servicios de Marketing",
              "type": "string"
            },
            {
              "id": "6aceeda4-66cd-4425-9784-a641b5260622",
              "name": "detalle_servicio",
              "value": "=`\n<p>¬°Gracias por tu consulta espec√≠fica sobre <strong>${$('Code in JavaScript').item.json.pregunta}</strong>!</p>\n\n<p>Es un tema muy interesante. Uno de nuestros especialistas revisar√° tu solicitud y se pondr√° en contacto contigo en breve para darte una respuesta detallada y ver c√≥mo podr√≠amos ayudarte con eso.</p>\n\n<p>Mientras tanto, te comento que nuestra especialidad es integrar consultas como la tuya dentro de una estrategia de marketing digital completa. Los pilares sobre los que construimos el √©xito de nuestros clientes son:</p>\n\n<ul style=\"padding-left: 20px;\">\n  <li><strong>Dise√±o y Desarrollo Web Profesional:</strong> Creamos sitios web r√°pidos y optimizados para convertir.</li>\n  <li><strong>Posicionamiento SEO (Local y Nacional):</strong> Hacemos que tus clientes te encuentren en Google.</li>\n</ul>\n\n<p>Te invitamos a ver c√≥mo hemos aplicado estas estrategias para otros negocios en <a href=\"httpsm://nlagencia.com/portafolio\" target=\"_blank\">nuestro portafolio</a> (reemplaza este enlace por el tuyo).</p>\n`",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2032,
        256
      ],
      "id": "a850c13c-af1b-44cb-b759-6639eb18437a",
      "name": "Set: Contenido General"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2368,
        80
      ],
      "id": "559de620-8a3a-44f8-aa6c-2c971859189f",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0b6f17a3-a653-4430-b8db-59ac0d71df07",
              "name": "link_agenda",
              "value": "https://cal.com/nelson-londono-dpobgm/estrategia15",
              "type": "string"
            },
            {
              "id": "b4011422-aab1-4479-af94-2b3c82c214b1",
              "name": "sessionId_final",
              "value": "={{ $json.body.sessionId ? $json.body.sessionId : $runId }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        128
      ],
      "id": "b69cd639-deb9-471d-b8b5-9527b8d0e34b",
      "name": "Set: Variables Globales"
    },
    {
      "parameters": {
        "fromEmail": "Nelson Londo√±o <contacto@nelsonlondono.es>",
        "toEmail": "={{ $('Code in JavaScript').item.json.correo }}",
        "subject": "Informaci√≥n sobre nuestros servicios - NLAgencia",
        "html": "={{ $('Set: Plantilla Email').item.json.email_html }}",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        2640,
        368
      ],
      "id": "1ad7d819-417f-4dff-91bf-7416accdae7b",
      "name": "Send email",
      "webhookId": "37692a0e-214e-42c7-baea-be7ef4ceaeb5",
      "credentials": {
        "smtp": {
          "id": "VpW8FmjBr7DgFyHQ",
          "name": "Hostinger SMTP"
        }
      }
    },
    {
      "parameters": {
        "height": 752,
        "width": 880
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2224,
        -176
      ],
      "typeVersion": 1,
      "id": "b56b5fc1-fa00-48c1-9361-2853cd5f2efc",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ response: `¬°Perfecto, ${$('Code in JavaScript').item.json.nombre}! He guardado tus datos.<br><br><a \n     href=\"${$('Set: Variables Globales').item.json.link_agenda}\" target=\"_blank\" rel=\"noopener noreferrer\">Haz clic aqu√≠ para agendar tu llamada \n     gratuita de 15 minutos</a>` }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1584,
        368
      ],
      "id": "bbb3db00-20d4-45e8-8d93-a732d132f830",
      "name": "Respond: Envia Link Agenda"
    }
  ],
  "pinData": {},
  "connections": {
    "4. Google Sheets: Guarda Datos del Cliente": {
      "main": [
        [
          {
            "node": "6. Telegram: Notifica al Equipo de Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. IF: ¬øEl cliente dio sus datos?": {
      "main": [
        [
          {
            "node": "4. Google Sheets: Guarda Datos del Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5. IF: ¬øQuiere correo o llamada?": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond: Envia Link Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6. Telegram: Notifica al Equipo de Ventas": {
      "main": [
        [
          {
            "node": "5. IF: ¬øQuiere correo o llamada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inicio_flujo": {
      "main": [
        [
          {
            "node": "Set: Variables Globales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Aurelio",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Aurelio": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "S√©neca": {
      "ai_languageModel": [
        [
          {
            "node": "Aurelio",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "3. IF: ¬øEl cliente dio sus datos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info_NLAgencia": {
      "ai_tool": [
        [
          {
            "node": "Aurelio",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set: Plantilla Email": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Set: Contenido SEO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set: Contenido Web",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set: Contenido General",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set: Contenido General": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Set: Contenido SEO": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set: Contenido Web": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Set: Plantilla Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set: Variables Globales": {
      "main": [
        [
          {
            "node": "Aurelio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "Europe/Madrid",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "b61deaae-a138-4be5-8350-1a816dc8b0ad",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fdffcaf648a7aa062da0ec843fff869b930e75adc5303a6a19e86b840cf683f2"
  },
  "id": "xFNrsSceTF0tPoyo",
  "tags": [
    {
      "updatedAt": "2025-09-28T16:58:02.211Z",
      "createdAt": "2025-09-28T16:58:02.211Z",
      "id": "Vw4ZtsC2SExt9mHJ",
      "name": "Sellings"
    }
  ]
}